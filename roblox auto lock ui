-- LocalScript inside StarterPlayerScripts
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Workspace = workspace

-- Settings
local settings = {
    snapRadius = 50,
    highlightEnabled = true,
    autoSnapEnabled = true,
    snapPower = 1
}

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Main black frame (not draggable)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 250)
mainFrame.Position = UDim2.new(0.5, -125, 0.5, -125)
mainFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
mainFrame.Visible = false
mainFrame.Parent = screenGui

-- Top draggable bar
local topBar = Instance.new("Frame")
topBar.Size = UDim2.new(1, 0, 0, 30)
topBar.Position = UDim2.new(0,0,0,0)
topBar.BackgroundColor3 = Color3.fromRGB(40,40,40)
topBar.Parent = mainFrame

-- Grey visual indicator
local indicator = Instance.new("Frame")
indicator.Size = UDim2.new(0, 100, 0, 5)
indicator.Position = UDim2.new(0.5, -50, 0.5, -2)
indicator.BackgroundColor3 = Color3.fromRGB(120,120,120)
indicator.Parent = topBar

-- Dragging logic for topBar only
do
    local dragging = false
    local dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    topBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    topBar.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            update(input)
        end
    end)
end

-- Open button (dragable)
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.new(0, 100, 0, 35)
openButton.Position = UDim2.new(0, 20, 0, 20)
openButton.Text = "Settings"
openButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
openButton.TextScaled = true
openButton.Parent = screenGui

-- Drag logic for open button
do
    local dragging = false
    local dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        openButton.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    openButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = openButton.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    openButton.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            update(input)
        end
    end)
end

openButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

-- Close button
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 50, 0, 25)
closeButton.Position = UDim2.new(1, -55, 0, 2)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(200,0,0)
closeButton.TextScaled = true
closeButton.Parent = topBar

closeButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
end)

-- Utility functions for UI
local function createLabel(text, position)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 220, 0, 25)
    label.Position = position
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.new(1,1,1)
    label.Text = text
    label.TextScaled = true
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = mainFrame
    return label
end

local function createSlider(min, max, default, position, callback)
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(0, 220, 0, 20)
    sliderFrame.Position = position
    sliderFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
    sliderFrame.Parent = mainFrame

    local fill = Instance.new("Frame")
    fill.Size = UDim2.new((default-min)/(max-min),0,1,0)
    fill.BackgroundColor3 = Color3.fromRGB(0,255,0)
    fill.Parent = sliderFrame

    local dragging = false
    sliderFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
        end
    end)
    sliderFrame.InputEnded:Connect(function(input)
        dragging = false
    end)
    sliderFrame.InputChanged:Connect(function(input)
        if dragging then
            local relativeX = math.clamp(input.Position.X - sliderFrame.AbsolutePosition.X, 0, sliderFrame.AbsoluteSize.X)
            local value = min + (relativeX/sliderFrame.AbsoluteSize.X)*(max-min)
            fill.Size = UDim2.new(relativeX/sliderFrame.AbsoluteSize.X,0,1,0)
            callback(value)
        end
    end)
end

local function createToggle(default, text, position, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 220, 0, 30)
    button.Position = position
    button.Text = text.." : "..tostring(default)
    button.BackgroundColor3 = Color3.fromRGB(80,80,80)
    button.TextScaled = true
    button.Parent = mainFrame

    button.MouseButton1Click:Connect(function()
        default = not default
        button.Text = text.." : "..tostring(default)
        callback(default)
    end)
end

-- Create UI elements
createLabel("Snap Radius", UDim2.new(0,10,0,40))
createSlider(10,200,settings.snapRadius,UDim2.new(0,10,0,65),function(value) settings.snapRadius = value end)

createLabel("Snap Power",UDim2.new(0,10,0,95))
createSlider(0,1,settings.snapPower,UDim2.new(0,10,0,120),function(value) settings.snapPower = value end)

createToggle(settings.highlightEnabled,"Highlight",UDim2.new(0,10,0,150),function(value) settings.highlightEnabled = value end)
createToggle(settings.autoSnapEnabled,"Auto Snap",UDim2.new(0,10,0,185),function(value) settings.autoSnapEnabled = value end)

-- Tables to track adornments
local highlightTable = {}
local boxTable = {}

-- Parts we want boxes on
local boxParts = {"Torso", "Head", "Left Arm", "Right Arm", "Left Leg", "Right Leg"}

-- Check visibility using raycast
local function isVisible(part)
    local direction = part.Position - Camera.CFrame.Position
    local ray = Ray.new(Camera.CFrame.Position, direction)
    local hitPart, _ = Workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character}, false, true)
    return hitPart and hitPart:IsDescendantOf(part.Parent)
end

-- Update highlights and boxes
local function updateHighlights()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            -- Highlight torso
            local torso = player.Character:FindFirstChild("Torso")
            if torso then
                if settings.highlightEnabled and not highlightTable[player] then
                    local hl = Instance.new("Highlight")
                    hl.Adornee = torso
                    hl.FillColor = Color3.fromRGB(255,0,0)
                    hl.FillTransparency = 0.6
                    hl.OutlineColor = Color3.fromRGB(255,255,255)
                    hl.OutlineTransparency = 0
                    hl.Parent = LocalPlayer:WaitForChild("PlayerGui")
                    highlightTable[player] = hl
                elseif not settings.highlightEnabled and highlightTable[player] then
                    highlightTable[player]:Destroy()
                    highlightTable[player] = nil
                end
            end

            -- Boxes on specific parts
            for _, partName in ipairs(boxParts) do
                local part = player.Character:FindFirstChild(partName)
                if part then
                    if isVisible(part) then
                        if not (boxTable[player] and boxTable[player][partName]) then
                            boxTable[player] = boxTable[player] or {}
                            local box = Instance.new("BoxHandleAdornment")
                            box.Adornee = part
                            box.Size = part.Size
                            box.Color3 = Color3.fromRGB(0,255,0)
                            box.Transparency = 0.5
                            box.AlwaysOnTop = true
                            box.ZIndex = 10
                            box.Parent = part
                            boxTable[player][partName] = box
                        end
                    else
                        if boxTable[player] and boxTable[player][partName] then
                            boxTable[player][partName]:Destroy()
                            boxTable[player][partName] = nil
                        end
                    end
                end
            end
        end
    end
end

-- Get closest visible target (raycast checks walls)
local function getVisibleTarget()
    local closest
    local closestDist = settings.snapRadius + 1
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local torso = player.Character:FindFirstChild("Torso")
            if torso then
                local dir = torso.Position - Camera.CFrame.Position
                local ray = Ray.new(Camera.CFrame.Position, dir)
                local hitPart, _ = Workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character}, false, true)
                if hitPart and hitPart:IsDescendantOf(player.Character) then
                    local dist = dir.Magnitude
                    if dist < closestDist then
                        closestDist = dist
                        closest = torso
                    end
                end
            end
        end
    end
    return closest
end

-- Main loop
RunService.RenderStepped:Connect(function()
    updateHighlights()

    if settings.autoSnapEnabled and settings.snapPower > 0 then
        local target = getVisibleTarget()
        if target then
            local direction = (target.Position - Camera.CFrame.Position)
            Camera.CFrame = Camera.CFrame:Lerp(CFrame.lookAt(Camera.CFrame.Position, Camera.CFrame.Position + direction), settings.snapPower)
        end
    end
end)

